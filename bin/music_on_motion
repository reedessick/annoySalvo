#!/usr/bin/python
usage = "music_on_motion [--options] config.ini"
description = "listens for motion through gpio and plays music when motion is detected"
author = "Reed Essick"

#=================================================

import annoySalvo as ass

import time
import random
import subprocess as sp
from ConfigParser import SafeConfigParser
from optparse import OptionParser

#=================================================

parser = OptionParser(usage=usage, description=description)

parser.add_option('-v', '--verbose', default=False, action='store_true')

opts, args = parser.parse_args()

if len(args)!=1:
    raise ValueError("Please supply exactly one config file as an input argument")

#=================================================

config = SafeConfigParser()
if opts.verbose:
    print "reading config from : %s"%args[0]
config.read( args[0] )

#========================

song = config.get('general', 'song')
random_delay = config.getfloat('general', 'random_delay')
play_length = config.getfloat('general', 'play_length')

#=================================================

if opts.verbose:
    print "setting up command"
cmd = ass.mplayer_cmd( song )
if opts.verbose:
    print "    %s"%(cmd)

while True:
    if ass.has_moved():

        wait = random_delay*random.random()
        if opts.verbose:
            print "sleeping for %.3f sec"%(wait)
        time.sleep( wait )

        if opts.verbose:
            print cmd
        proc = sp.Popen(cmd.split())
        time.sleep( play_length ) ### sleep for timeout
        proc.kill()
        proc.wait() ### make sure we clean up?

        break ### only play once
    else:
        time.sleep(1) ### only check every second

